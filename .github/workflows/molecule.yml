---
name: Molecule Tests
on:
  pull_request:
  push:
    branches:
      - main
  # TODO: test dev weekly
jobs:
  molecule:
    name: molecule
    # systemd may not work under 22.04 due to cgroupsv2
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        scenario:
          - default
        from-image:
          - ubuntu:22.04
        galaxy-version:
          - 'dev'
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 1

      - uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # The molecule-docker pin can be removed after molecule-docker>2.1.0 is released, see:
      # https://github.com/ansible-community/molecule/issues/3733
      - name: Install dependencies
        run: pip3 install molecule[docker] ansible-core 'molecule-docker!=2.1.0'

      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: true

      - name: Run molecule
        run: molecule test -s ${{ matrix.scenario }}
        env:
          PY_COLORS: '1'
          ANSIBLE_FORCE_COLOR: '1'
          ANSIBLE_STDOUT_CALLBACK: yaml
          FROM_IMAGE: '${{ matrix.from-image }}'
          GALAXY_COMMIT_ID: 'release_${{ matrix.galaxy-version }}'
          GALAXY_VERSION: '${{ matrix.galaxy-version }}'
