---
name: Docker Build Tests

on:
  pull_request:
  push:
    # branches:
    #   - main

jobs:
  docker-build:
    name: docker-build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        galaxy-branch:
          - dev
          - master
    steps:
      - name: Checkout ansible-galaxy role
        uses: actions/checkout@v4
        with:
          path: ansible-galaxy-role

      - name: Checkout Galaxy
        uses: actions/checkout@v4
        with:
          repository: galaxyproject/galaxy
          ref: ${{ matrix.galaxy-branch }}
          path: galaxy

      - name: Use simplified Dockerfile (single build stage)
        run: |
          # Download the new simplified Dockerfile that drops separate server/client build stages
          curl -sL https://raw.githubusercontent.com/galaxyproject/galaxy/bf302e24fefac14782110f10e6d29369be785b70/.k8s_ci.Dockerfile -o galaxy/.k8s_ci.Dockerfile

      - name: Patch Dockerfile to use local ansible-galaxy role
        run: |
          # Copy role into galaxy directory so it's in the build context
          cp -r ansible-galaxy-role galaxy/ansible-galaxy-role
          # Add a COPY instruction after ansible-galaxy install to override the role
          sed -i '/ansible-galaxy install -r requirements.yml/a COPY ansible-galaxy-role /tmp/ansible/galaxy-docker/roles/galaxy' galaxy/.k8s_ci.Dockerfile

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: galaxy
          file: galaxy/.k8s_ci.Dockerfile
          push: false
          load: true
          tags: galaxy-test:${{ matrix.galaxy-branch }}

      - name: Test Galaxy container starts
        run: |
          # Start container in background
          docker run -d --name galaxy-test -p 8080:8080 galaxy-test:${{ matrix.galaxy-branch }}

          # Wait for Galaxy to be ready (up to 5 minutes)
          echo "Waiting for Galaxy to start..."
          for i in $(seq 1 60); do
            if curl -sf http://localhost:8080/api/version > /dev/null 2>&1; then
              echo "Galaxy is ready!"
              curl -s http://localhost:8080/api/version | jq .
              exit 0
            fi
            echo "Attempt $i/60: Galaxy not ready yet, waiting..."
            sleep 5
          done

          echo "Galaxy failed to start within timeout"
          docker logs galaxy-test
          exit 1
